import React, { useEffect, useState } from 'react'
import { useParams } from 'react-router-dom'
import { useGetEvent } from '@/features/events/hooks/useEvents'
import { useCurrentUser } from '@/features/auth/hooks/useAuth'
import { PageLayout } from '@/shared/components/PageLayout'
import { PhotoCapture } from '@/shared/components/PhotoCapture'
import { eventService } from '@/features/events/services/eventService'
import { useFaceDetection, useFaceSearch } from '@/features/faces/hooks/useFaceDetection'
import { Event, EventPhoto } from '@/features/events/types'
import QRCode from 'qrcode.react'
import { Copy, Check, AlertCircle, Loader, Search, CheckCircle } from 'lucide-react'
import toast from 'react-hot-toast'

export function EventDetailPage() {
  const { eventId } = useParams<{ eventId: string }>()
  const { user: currentUser } = useCurrentUser()
  const { event: hookedEvent } = useGetEvent(eventId || '')
  const [event, setEvent] = useState<Event | null>(hookedEvent || null)
  const [isLoadingEvent, setIsLoadingEvent] = useState(true)
  const [copied, setCopied] = useState(false)
  const [isOfflineMode, setIsOfflineMode] = useState(false)
  const [showPhotoCapture, setShowPhotoCapture] = useState(false)
  const [isProcessing, setIsProcessing] = useState(false)
  const [faceMatches, setFaceMatches] = useState<
    Array<{ photoId: string; photo: EventPhoto; confidence: number }>
  >([])
  const [searchCompleted, setSearchCompleted] = useState(false)
  const [showJoinConfirm, setShowJoinConfirm] = useState(false)
  const [isJoining, setIsJoining] = useState(false)
  const [isUserOrganizer, setIsUserOrganizer] = useState(false)
  const [isUserParticipant, setIsUserParticipant] = useState(false)

  const { detectFaces } = useFaceDetection()
  const { searchFaces } = useFaceSearch()

  const updateRoleStatus = (event: Event | null, userId: string | undefined) => {
    if (!event || !userId) {
      setIsUserOrganizer(false)
      setIsUserParticipant(false)
      return
    }
    
    setIsUserOrganizer(event.organizerId === userId)
    setIsUserParticipant(event.participants.includes(userId) && event.organizerId !== userId)
  }

  const handleJoinEvent = async () => {
    if (!event || !currentUser?.id) return
    
    setIsJoining(true)
    try {
      await eventService.addEventParticipant(event.id, currentUser.id)
      
      // Update local event state
      const updatedEvent = { ...event, participants: [...event.participants, currentUser.id] }
      setEvent(updatedEvent)
      updateRoleStatus(updatedEvent, currentUser.id)
      
      toast.success('EtkinliÄŸe katÄ±ldÄ±nÄ±z!')
      setShowJoinConfirm(false)
    } catch (error) {
      console.error('Error joining event:', error)
      toast.error('EtkinliÄŸe katÄ±lÄ±rken hata oluÅŸtu')
    } finally {
      setIsJoining(false)
    }
  }

  useEffect(() => {
    const fetchEvent = async () => {
      setIsLoadingEvent(true)
      try {
        if (eventId) {
          // First try to get from hook
          if (hookedEvent) {
            setEvent(hookedEvent)
            updateRoleStatus(hookedEvent, currentUser?.id)
          } else {
            // Try to get directly from service
            const fetchedEvent = await eventService.getEvent(eventId)
            setEvent(fetchedEvent)
            updateRoleStatus(fetchedEvent, currentUser?.id)

            // If accessed via /share link, show confirmation dialog
            if (window.location.pathname.includes('/share/')) {
              const isAlreadyParticipant = fetchedEvent?.participants.includes(currentUser?.id || '')
              if (!isAlreadyParticipant) {
                setShowJoinConfirm(true)
              }
            }
          }
        }
      } catch (error) {
        console.error('Error loading event:', error)
        // In offline mode, create placeholder
        setIsOfflineMode(true)
        const placeholderEvent: Event = {
          id: eventId || 'unknown',
          title: 'Etkinlik YÃ¼kleniyor...',
          description: 'Bu etkinlik ÅŸu anda yÃ¼klenmemiÅŸ. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.',
          organizerId: 'unknown',
          status: 'draft',
          shareLink: window.location.href,
          qrCode: '',
          participants: [],
          photoIds: [],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        }
        setEvent(placeholderEvent)
        updateRoleStatus(placeholderEvent, currentUser?.id)
      } finally {
        setIsLoadingEvent(false)
      }
    }

    fetchEvent()
  }, [eventId, hookedEvent, currentUser?.id])

  const handleCopyLink = () => {
    if (event?.shareLink) {
      navigator.clipboard.writeText(event.shareLink)
      setCopied(true)
      toast.success('Link kopyalandÄ±!')
      setTimeout(() => setCopied(false), 2000)
    }
  }

  const handlePhotoCapture = async (file: File) => {
    if (!event) return

    setIsProcessing(true)
    setFaceMatches([])
    setSearchCompleted(false)

    try {
      // Step 1: Detect faces in captured photo
      const detectedFaces = await detectFaces(file)

      if (!detectedFaces || detectedFaces.length === 0) {
        toast.error('FotoÄŸrafta yÃ¼z algÄ±lanamadÄ±. LÃ¼tfen baÅŸka bir fotoÄŸraf deneyin.')
        setIsProcessing(false)
        return
      }

      // Step 2: Save the uploaded photo to event
      const uploadedPhoto = await eventService.uploadPhoto(event.id, file)

      // Step 3: Save face embeddings for the uploaded photo
      const uploadedEmbeddings = detectedFaces.map((face) => face.embeddings)
      await eventService.saveFaceEmbeddings(uploadedPhoto.id, uploadedEmbeddings)

      toast.success('FotoÄŸraf yÃ¼klendi! YÃ¼zler aranÄ±yor...')

      // Step 4: Get all face embeddings from other event photos
      const eventFaceEmbeddings = await eventService.getEventFaceEmbeddings(
        event.id
      )

      // Filter out the just-uploaded photo
      const otherPhotosEmbeddings = eventFaceEmbeddings.filter(
        (item) => item.photoId !== uploadedPhoto.id
      )

      if (otherPhotosEmbeddings.length === 0) {
        toast.success('Etkinlikte karÅŸÄ±laÅŸtÄ±rÄ±lacak baÅŸka fotoÄŸraf yok.')
        setIsProcessing(false)
        setSearchCompleted(true)
        return
      }

      // Step 5: Search for matching faces
      const sourceEmbedding = detectedFaces[0].embeddings // Use first detected face
      const matches = await searchFaces(
        sourceEmbedding,
        otherPhotosEmbeddings,
        0.5 // threshold
      )

      // Step 6: Get the matching photos
      const allPhotos = await eventService.getEventPhotos(event.id)
      const matchedPhotos = matches.map((match) => ({
        photoId: match.photoId,
        photo: allPhotos.find((p) => p.id === match.photoId)!,
        confidence: match.confidence,
      }))

      setFaceMatches(matchedPhotos)
      setSearchCompleted(true)

      if (matchedPhotos.length > 0) {
        toast.success(`${matchedPhotos.length} eÅŸleÅŸme bulundu!`)
      } else {
        toast.success('HiÃ§ eÅŸleÅŸme bulunamadÄ±.')
      }
    } catch (error) {
      console.error('Error processing photo:', error)
      toast.error('FotoÄŸraf iÅŸlenirken hata oluÅŸtu')
    } finally {
      setIsProcessing(false)
      setShowPhotoCapture(false)
    }
  }

  if (isLoadingEvent) {
    return (
      <PageLayout>
        <div className="text-center py-12">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"></div>
          <p className="mt-4 text-gray-600">YÃ¼kleniyor...</p>
        </div>
      </PageLayout>
    )
  }

  if (!event) {
    return (
      <PageLayout>
        <div className="text-center py-12">
          <AlertCircle className="w-12 h-12 text-warning-600 mx-auto mb-4" />
          <p className="text-warning-600 font-semibold">Etkinlik ÅŸu anda yÃ¼klenemedi</p>
          <p className="text-gray-600 text-sm mt-2">
            Ä°nternet baÄŸlantÄ±sÄ±nÄ± kontrol edin ve sayfayÄ± yenileyin
          </p>
        </div>
      </PageLayout>
    )
  }

  return (
    <PageLayout>
      <div className="max-w-4xl mx-auto">
        {/* Offline mode warning */}
        {isOfflineMode && (
          <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg flex items-start gap-3">
            <AlertCircle className="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" />
            <div>
              <p className="text-yellow-800 font-semibold">Ã‡evrimdÄ±ÅŸÄ± Mod</p>
              <p className="text-yellow-700 text-sm mt-1">
                Etkinlik yerel cihazdan gÃ¶steriliyor. Etkinlik detaylarÄ± tam olmayabilir.
              </p>
            </div>
          </div>
        )}

        <h1 className="text-3xl font-bold text-gray-900 mb-6">{event.title}</h1>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
          {/* QR Code - Organizer Only */}
          {isUserOrganizer && (
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-lg font-semibold text-gray-900 mb-4">QR Kod</h2>
              <div className="flex justify-center p-4 bg-gray-50 rounded-lg">
                {event.shareLink ? (
                  <QRCode value={event.shareLink} size={256} level="H" />
                ) : (
                  <div className="w-64 h-64 bg-gray-200 rounded flex items-center justify-center">
                    <span className="text-gray-500">QR Kod</span>
                  </div>
                )}
              </div>
              <p className="text-sm text-gray-600 text-center mt-4">
                KatÄ±lÄ±mcÄ±larÄ±nÄ±zla bu QR kodu paylaÅŸÄ±n
              </p>
            </div>
          )}

          {/* Share Link - Organizer Only */}
          {isUserOrganizer && (
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-lg font-semibold text-gray-900 mb-4">PaylaÅŸÄ±m Linki</h2>
              <div className="flex gap-2 mb-4">
                <input
                  type="text"
                  value={event.shareLink}
                  readOnly
                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"
                />
                <button
                  onClick={handleCopyLink}
                  className="flex items-center gap-2 px-3 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
                >
                  {copied ? (
                    <Check className="w-4 h-4" />
                  ) : (
                    <Copy className="w-4 h-4" />
                  )}
                </button>
              </div>
            </div>
          )}

        {/* Photo Capture Component */}
        {showPhotoCapture && (
          <div className="mb-8">
            <PhotoCapture
              onPhotoCapture={handlePhotoCapture}
              onPhotoUpload={handlePhotoCapture}
            />
          </div>
        )}

        {/* Processing Status */}
        {isProcessing && (
          <div className="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div className="flex items-center gap-3">
              <Loader className="w-5 h-5 text-blue-600 animate-spin" />
              <div>
                <p className="text-blue-900 font-semibold">YÃ¼zler AranÄ±yor</p>
                <p className="text-blue-700 text-sm mt-1">
                  LÃ¼tfen bekleyin. YÃ¼zleri diÄŸer fotoÄŸraflarla karÅŸÄ±laÅŸtÄ±rÄ±yoruz...
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Face Matches Results */}
        {searchCompleted && faceMatches.length > 0 && (
          <div className="mb-8">
            <h2 className="text-2xl font-bold text-gray-900 mb-4">
              ğŸ“ EÅŸleÅŸmeler Bulundu ({faceMatches.length})
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {faceMatches.map((match) => (
                <div
                  key={match.photoId}
                  className="bg-white rounded-lg shadow hover:shadow-lg transition-shadow overflow-hidden"
                >
                  <div className="relative">
                    <img
                      src={match.photo.imageUrl}
                      alt="Matched photo"
                      className="w-full h-48 object-cover"
                    />
                    <div className="absolute top-2 right-2 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold">
                      {(match.confidence * 100).toFixed(0)}%
                    </div>
                  </div>
                  <div className="p-3">
                    <p className="text-sm text-gray-600">
                      {new Date(match.photo.uploadedAt).toLocaleDateString('tr-TR')}
                    </p>
                    <p className="text-xs text-gray-500 mt-1">
                      Benzerlik: {(match.confidence * 100).toFixed(1)}%
                    </p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* No Matches Found */}
        {searchCompleted && faceMatches.length === 0 && (
          <div className="mb-8 p-6 bg-gray-50 border border-gray-200 rounded-lg text-center">
            <p className="text-gray-600 font-semibold">
              ğŸ˜” HiÃ§ eÅŸleÅŸme bulunamadÄ±
            </p>
            <p className="text-gray-500 text-sm mt-2">
              Bu kiÅŸi etkinliÄŸin diÄŸer fotoÄŸraflarÄ±nda gÃ¶rÃ¼nmÃ¼yor.
            </p>
          </div>
        )}

        {/* Event Info */}
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold text-gray-900 mb-4">Etkinlik Bilgileri</h2>
          <p className="text-gray-700 mb-4">{event.description}</p>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <p className="text-sm text-gray-600">Durum</p>
              <p className="font-semibold text-gray-900 capitalize">{event.status}</p>
            </div>
            <div>
              <p className="text-sm text-gray-600">KatÄ±lÄ±mcÄ± SayÄ±sÄ±</p>
              <p className="font-semibold text-gray-900">{event.participants.length}</p>
            </div>
            <div>
              <p className="text-sm text-gray-600">FotoÄŸraf SayÄ±sÄ±</p>
              <p className="font-semibold text-gray-900">{event.photoIds.length}</p>
            </div>
            <div>
              <p className="text-sm text-gray-600">OluÅŸturma Tarihi</p>
              <p className="font-semibold text-gray-900">
                {new Date(event.createdAt).toLocaleDateString('tr-TR')}
              </p>
            </div>
          </div>
        </div>
      </div>
    </PageLayout>
  )
}
